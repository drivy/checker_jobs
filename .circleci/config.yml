version: 2
jobs:
  build:
    docker:
      - image: drivy/rails-ci:0.1.2
    steps:
      - checkout

      - run: git fetch origin --depth=1000

      - run:
          name: "Creating a Gemfile.lock without bundler's version"
          command: "head -n -3 Gemfile.lock > Gemfile.lock.no-version"

      # Bundle install with cache, Ignore bundler version
      - restore_cache:
          key: checker_jobs-{{ checksum "Gemfile.lock.no-version"}}
      - run:
          name: Install Ruby dependencies
          command: bundle install --path vendor/bundle --jobs=`nproc`
      - save_cache:
          key: checker_jobs-{{ checksum "Gemfile.lock.no-version"}}
          paths:
            - vendor/bundle

      - run:
          name: RSpec
          command: bundle exec rspec --format documentation

      - run:
          name: Pronto
          command: bin/pronto-ci
